@page "/"
@using ERP.UI.Blazor.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@attribute [Authorize]
@* @inject ApiService ApiService *@
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Home</PageTitle>

@* <h1>Hello, @userName!</h1>

<p>User ID: @userId</p>

<AuthorizeView>
    you are authorized
</AuthorizeView>

<button @onclick="GetMe">Me</button>

<InputText @bind-Value=@Ok /> *@
@* 
@code {
    private String Ok = "";
    private string userName = "";
    private string userId = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            userName = user.Identity.Name ?? "Unknown";
            userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "Unknown";
        }
    }

    private async Task GetMe()
    {
        // ✅ Use ApiService - it will auto-redirect to /logout on 401
        var response = await ApiService.GetAsync("IAM/me");

        if (response.IsSuccessStatusCode)
        {
            Ok = "everything is ok";
        }
        else if (response.StatusCode != System.Net.HttpStatusCode.Unauthorized)
        {
            // Don't show error for 401 since we're redirecting
            Ok = $"Error: {response.StatusCode}";
        }

        StateHasChanged();
    }
} *@