@page "/download-payslip/{PersonnelCode?}/{Year?}/{Month?}"
@using ERP.UI.Blazor.Models
@inject IHttpClientFactory ClientFactory
@inject IJSRuntime JS



@if (loading)
{
    <div class="payslip-container">
        <div class="card">در حال بارگذاری...</div>
    </div>
}
else if (error != null)
{
    <div class="payslip-container">
        <div class="card">@error</div>
    </div>
}
else if (payslip != null)
{
    <div class="payslip-container">

        <button class="btn btn-primary" @onclick="DownloadPdf" style="width:100%; margin-bottom:15px;">
            دانلود PDF
        </button>

        <div class="card">
            <div class="title">فیش حقوقی @payslip.Month @payslip.Year</div>

            <div class="section-title">اطلاعات فردی</div>
            <div class="row"><div class="label">کد پرسنلی:</div><div class="value">@payslip.PersonnelCode</div></div>
            <div class="row"><div class="label">نام:</div><div class="value">@payslip.FullName</div></div>

            <div class="section-title">حقوق پایه</div>
            <div class="row"><div class="label">حقوق روزانه:</div><div class="value">@payslip.DailySalary</div></div>
            <div class="row"><div class="label">تعداد روز کاری:</div><div class="value">@payslip.WorkingDays</div></div>
            <div class="row"><div class="label">حقوق ثابت:</div><div class="value">@payslip.MonthlyBaseSalary</div></div>

            <div class="section-title">مزایا</div>
            <div class="row"><div class="label">بن کارگری:</div><div class="value">@payslip.WorkerBenefit</div></div>
            <div class="row"><div class="label">حق مسکن:</div><div class="value">@payslip.HousingAllowance</div></div>
            <div class="row"><div class="label">حق اولاد:</div><div class="value">@payslip.ChildAllowance</div></div>
            <div class="row"><div class="label">حق ناهار:</div><div class="value">@payslip.LunchAllowance</div></div>

            <div class="section-title">کسورات</div>
            <div class="row"><div class="label">بیمه کارگر:</div><div class="value">@payslip.InsuranceWorkerShare</div></div>
            <div class="row"><div class="label">بیمه تکمیلی:</div><div class="value">@payslip.SupplementaryInsurance</div></div>
            <div class="row"><div class="label">مالیات:</div><div class="value">@payslip.SalaryTax</div></div>

            <div class="section-title">نتیجه نهایی</div>
            <div class="row"><div class="label">جمع مزایا:</div><div class="value">@payslip.TotalSalaryAndBenefits</div></div>
            <div class="row"><div class="label">جمع کسورات:</div><div class="value">@payslip.TotalDeductions</div></div>
            <div class="row"><div class="label">خالص پرداختی:</div><div class="value">@payslip.NetPayable</div></div>

        </div>
    </div>
}



@code {
    [Parameter] public string PersonnelCode { get; set; } = "20561";
    [Parameter] public string Year { get; set; } = "1404";
    [Parameter] public string Month { get; set; } = "9";


    private DownloadPayslipDto? payslip;
    private bool loading = true;
    private string? error;
    private HttpClient http => ClientFactory.CreateClient("Api");

    protected override async Task OnInitializedAsync()
    {
        try
        {
            payslip = await http.GetFromJsonAsync<DownloadPayslipDto>($"payslip/download/{PersonnelCode}/{Year}/{Month}"); 
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task DownloadPdf()
    {
        var response = await http.PostAsJsonAsync("Payslip/GetPdf", payslip);

        if (!response.IsSuccessStatusCode)
        {
            Console.WriteLine("Failed to download PDF");
            return;
        }

        var pdfBytes = await response.Content.ReadAsByteArrayAsync();

        var fileName = $"Payslip_{payslip.PersonnelCode}_{payslip.Year}_{payslip.Month}.pdf";

        using var streamRef = new DotNetStreamReference(new MemoryStream(pdfBytes));
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}

<style>

.payslip-container {
    max-width: 600px;
    margin: 20px auto;
    direction: rtl;
    font-family: 'Segoe UI', sans-serif;
}

.card {
    background: #fff;
    border-radius: 14px;
    padding: 20px 25px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 12px;
    text-align: center;
}

.section-title {
    margin-top: 18px;
    font-weight: 600;
    color: #444;
    border-right: 4px solid #ffb300;
    padding-right: 6px;
}

.row {
    display: flex;
    justify-content: space-between;
    margin: 6px 0;
}

.label {
    color: #666;
}

.value {
    font-weight: 600;
}
</style>